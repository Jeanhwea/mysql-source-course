#+TITLE: 子查询优化器分析示例
#+AUTHOR: Jinghui Hu
#+EMAIL: hujinghui@buaa.edu.cn
#+DATE: <2024-07-01 Mon>
#+STARTUP: overview num indent
#+OPTIONS: ^:nil
#+PROPERTY: header-args:sql :dbhost 127.0.0.1 :database employees :engine mysql :dbuser root :exports both


* subq01
- 标量子查询 [[file:subq01_scalar_exp.sql.json][exp_json]] | [[file:subq01_scalar_opt.sql.json][opt_trace]]
  #+BEGIN_SRC sql
    explain
    select
      count(distinct emp_no) as emp_cnt
    from
      dept_emp a
    where
      a.emp_no < 10100
      and a.dept_no = (
        select
          d.dept_no
        from
          departments d
        where
          d.dept_name = 'Development');
  #+END_SRC

  #+RESULTS:
  | id | select_type | table | partitions | type  | possible_keys   | key       | key_len | ref   | rows | filtered | Extra                    |
  |----+-------------+-------+------------+-------+-----------------+-----------+---------+-------+------+----------+--------------------------|
  |  1 | PRIMARY     | a     | NULL       | range | PRIMARY,dept_no | dept_no   |      20 | NULL  |   32 |   100.00 | Using where; Using index |
  |  2 | SUBQUERY    | d     | NULL       | const | dept_name       | dept_name |     162 | const |    1 |   100.00 | Using index              |

* subq02
- 唯一性的 IN 子查询 [[file:subq02_unique_exp.sql.json][exp_json]] | [[file:subq02_unique_opt.sql.json][opt_trace]]
  #+BEGIN_SRC sql
    explain
    select
      e.first_name, e.last_name
    from
      employees e
    where
      e.emp_no in (
        select
          a.emp_no
        from
           dept_manager a
        where
          a.dept_no = 'd001');
  #+END_SRC

  #+RESULTS:
  | id | select_type | table | partitions | type   | possible_keys   | key     | key_len | ref                | rows | filtered | Extra                    |
  |----+-------------+-------+------------+--------+-----------------+---------+---------+--------------------+------+----------+--------------------------|
  |  1 | SIMPLE      | a     | NULL       | ref    | PRIMARY,dept_no | dept_no |      16 | const              |    2 |   100.00 | Using where; Using index |
  |  1 | SIMPLE      | e     | NULL       | eq_ref | PRIMARY         | PRIMARY |       4 | employees.a.emp_no |    1 |   100.00 | NULL                     |

* subq03
- 非唯一性的 IN 子查询 [[file:subq03_non-unique_exp.sql.json][exp_json]] | [[file:subq03_non-unique_opt.sql.json][opt_trace]]
  #+BEGIN_SRC sql
    explain
    select
      ,*
    from
      departments d
    where
      d.dept_no in (
        select
          a.dept_no
        from
          dept_manager a
        where
          a.from_date >= '1995-01-01');
  #+END_SRC

  #+RESULTS:
  | id | select_type  | table       | partitions | type   | possible_keys       | key                 | key_len | ref                 | rows | filtered | Extra       |
  |----+--------------+-------------+------------+--------+---------------------+---------------------+---------+---------------------+------+----------+-------------|
  |  1 | SIMPLE       | d           | NULL       | index  | PRIMARY             | dept_name           |     162 | NULL                |    9 |   100.00 | Using index |
  |  1 | SIMPLE       | <subquery2> | NULL       | eq_ref | <auto_distinct_key> | <auto_distinct_key> |      16 | employees.d.dept_no |    1 |   100.00 | NULL        |
  |  2 | MATERIALIZED | a           | NULL       | ALL    | dept_no             | NULL                |    NULL | NULL                |   24 |    33.33 | Using where |

* subq04
- EXISTS 子查询 [[file:subq04_exists_exp.sql.json][exp_json]] | [[file:subq04_exists_opt.sql.json][opt_trace]]
  #+BEGIN_SRC sql
    explain
    select
      e.first_name,
      e.last_name
    from
      employees e
    where
      exists (
        select
          ,*
        from
          dept_manager a
        where
          a.dept_no = 'd001'
          and a.emp_no = e.emp_no);
  #+END_SRC

  #+RESULTS:
  | id | select_type | table | partitions | type   | possible_keys   | key     | key_len | ref                | rows | filtered | Extra                    |
  |----+-------------+-------+------------+--------+-----------------+---------+---------+--------------------+------+----------+--------------------------|
  |  1 | SIMPLE      | a     | NULL       | ref    | PRIMARY,dept_no | dept_no |      16 | const              |    2 |   100.00 | Using where; Using index |
  |  1 | SIMPLE      | e     | NULL       | eq_ref | PRIMARY         | PRIMARY |       4 | employees.a.emp_no |    1 |   100.00 | NULL                     |

* subq10
1. [[https://dev.mysql.com/doc/refman/8.0/en/optimizer-hints.html][hits]]
- 默认
  #+BEGIN_SRC sql
    explain
    select
      ,*
    from
      departments d
    where
      d.dept_no in (
        select
          a.dept_no
        from
          dept_manager a
        where
          a.from_date >= '1995-01-01');
  #+END_SRC

  #+RESULTS:
  | id | select_type  | table       | partitions | type   | possible_keys       | key                 | key_len | ref                 | rows | filtered | Extra       |
  |----+--------------+-------------+------------+--------+---------------------+---------------------+---------+---------------------+------+----------+-------------|
  |  1 | SIMPLE       | d           | NULL       | index  | PRIMARY             | dept_name           |     162 | NULL                |    9 |   100.00 | Using index |
  |  1 | SIMPLE       | <subquery2> | NULL       | eq_ref | <auto_distinct_key> | <auto_distinct_key> |      16 | employees.d.dept_no |    1 |   100.00 | NULL        |
  |  2 | MATERIALIZED | a           | NULL       | ALL    | dept_no             | NULL                |    NULL | NULL                |   24 |    33.33 | Using where |

** DuplicateWeedout
  #+BEGIN_SRC sql
    explain

    select
      ,*
    from
      departments d
    where
      d.dept_no in (
        select
          /*+ SEMIJOIN(DUPSWEEDOUT) */
          a.dept_no
        from
          dept_manager a
        where
          a.from_date >= '1995-01-01');
  #+END_SRC

  #+RESULTS:
  | id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref                 | rows | filtered | Extra                        |
  |----+-------------+-------+------------+--------+---------------+---------+---------+---------------------+------+----------+------------------------------|
  |  1 | SIMPLE      | a     | NULL       | ALL    | dept_no       | NULL    | NULL    | NULL                |   24 |    33.33 | Using where; Start temporary |
  |  1 | SIMPLE      | d     | NULL       | eq_ref | PRIMARY       | PRIMARY | 16      | employees.a.dept_no |    1 |   100.00 | End temporary                |

** FirstMatch
#+BEGIN_SRC sql
  explain

  select
    ,*
  from
    departments d
  where
    d.dept_no in (
      select
        /*+ SEMIJOIN(FIRSTMATCH) */
        a.dept_no
      from
        dept_manager a
      where
        a.from_date >= '1995-01-01');
#+END_SRC

#+RESULTS:
| id | select_type | table | partitions | type  | possible_keys | key       | key_len | ref                 | rows | filtered | Extra                      |
|----+-------------+-------+------------+-------+---------------+-----------+---------+---------------------+------+----------+----------------------------|
|  1 | SIMPLE      | d     | NULL       | index | PRIMARY       | dept_name |     162 | NULL                |    9 |   100.00 | Using index                |
|  1 | SIMPLE      | a     | NULL       | ref   | dept_no       | dept_no   |      16 | employees.d.dept_no |    2 |    33.33 | Using where; FirstMatch(d) |

** LooseScan
#+BEGIN_SRC sql
  explain

  select
    ,*
  from
    departments d
  where
    d.dept_no in (
      select
        /*+ SEMIJOIN(LOOSESCAN) */
        a.dept_no
      from
        dept_manager a
      where
        a.from_date >= '1995-01-01');
#+END_SRC

#+RESULTS:
| id | select_type | table | partitions | type   | possible_keys | key     | key_len | ref                 | rows | filtered | Extra                        |
|----+-------------+-------+------------+--------+---------------+---------+---------+---------------------+------+----------+------------------------------|
|  1 | SIMPLE      | a     | NULL       | ALL    | dept_no       | NULL    | NULL    | NULL                |   24 |    33.33 | Using where; Start temporary |
|  1 | SIMPLE      | d     | NULL       | eq_ref | PRIMARY       | PRIMARY | 16      | employees.a.dept_no |    1 |   100.00 | End temporary                |

* subq14
- MaterializeScan 参考 | [[*subq03][subq03]]
